
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../preparation/">
      
      
        <link rel="next" href="../my_changes/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Conatainers - Belenios on AWS</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#containers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Belenios on AWS" class="md-header__button md-logo" aria-label="Belenios on AWS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Belenios on AWS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Conatainers
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Belenios on AWS" class="md-nav__button md-logo" aria-label="Belenios on AWS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Belenios on AWS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Workstation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Workstation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Development setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Install Belenios
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../preparation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prepare squashfs image
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" checked>
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Conatainers
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Conatainers
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#isolation" class="md-nav__link">
    <span class="md-ellipsis">
      Isolation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-do-the-scripts-do" class="md-nav__link">
    <span class="md-ellipsis">
      What do the scripts do?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What do the scripts do?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#podman-build" class="md-nav__link">
    <span class="md-ellipsis">
      podman build
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#podman-run" class="md-nav__link">
    <span class="md-ellipsis">
      podman run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-run-rootfssquashfs-with-systemd-nspawn" class="md-nav__link">
    <span class="md-ellipsis">
      To run rootfs.squashfs with systemd-nspawn
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-run-as-systemd-service" class="md-nav__link">
    <span class="md-ellipsis">
      To run as systemd service
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspect-with-machinectl" class="md-nav__link">
    <span class="md-ellipsis">
      Inspect with machinectl
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../my_changes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    My changes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../selinux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SELinux
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    AWS
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            AWS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../aws/deploy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../aws/email/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Set up email
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../aws/dns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Set up DNS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../aws/troubleshoot/msmtp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    msmtp
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#isolation" class="md-nav__link">
    <span class="md-ellipsis">
      Isolation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-do-the-scripts-do" class="md-nav__link">
    <span class="md-ellipsis">
      What do the scripts do?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What do the scripts do?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#podman-build" class="md-nav__link">
    <span class="md-ellipsis">
      podman build
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#podman-run" class="md-nav__link">
    <span class="md-ellipsis">
      podman run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-run-rootfssquashfs-with-systemd-nspawn" class="md-nav__link">
    <span class="md-ellipsis">
      To run rootfs.squashfs with systemd-nspawn
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-run-as-systemd-service" class="md-nav__link">
    <span class="md-ellipsis">
      To run as systemd service
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspect-with-machinectl" class="md-nav__link">
    <span class="md-ellipsis">
      Inspect with machinectl
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="containers">Containers</h1>
<h2 id="isolation">Isolation</h2>
<p><code>chroot</code>, <code>unshare</code>, <code>systemd-nspawn</code>, <code>podman</code>, <code>docker</code> all provide isolation, to different degrees, of files, processes, user namespaces, networks, and more.   Containers "contain" or "isolate" something in some way.  Code is on the same file system as it always was.  It is just "contained" or isolated and hence more secure and portable (to the extent it doesn't have external dependencies).  </p>
<p>All of these isolation mechanisms are used in producing a squashfs image for runnning Belenios.</p>
<p>The outcome, is a squashfs image which can be run by systemd-nspawn as a systemd service on the host. </p>
<p>Comparison table:</p>
<table>
<thead>
<tr>
<th>Feature / Tool</th>
<th><strong>chroot</strong></th>
<th><strong>unshare</strong></th>
<th><strong>systemd-nspawn</strong></th>
<th><strong>docker</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Purpose</strong></td>
<td>Change root directory for a process (filesystem isolation)</td>
<td>Run a program with new Linux namespaces (fine-grained isolation)</td>
<td>Lightweight container manager built on Linux namespaces &amp; cgroups (part of systemd)</td>
<td>Full container platform with runtime, networking, orchestration, and registry integration</td>
</tr>
<tr>
<td><strong>Isolation Level</strong></td>
<td>Filesystem only (unless combined with other tools)</td>
<td>User-specified namespaces (PID, NET, UTS, IPC, USER, MNT, etc.)</td>
<td>Filesystem + namespaces (PID, NET, IPC, UTS, user) + cgroups resource limits</td>
<td>Full isolation with namespaces, cgroups, seccomp, capabilities</td>
</tr>
<tr>
<td><strong>Security</strong></td>
<td>Weak (processes can escape with root privileges unless extra measures)</td>
<td>Stronger if combined namespaces are used, but depends on config</td>
<td>Stronger — drops capabilities, applies cgroups, integrates with systemd security features</td>
<td>Strongest by default — adds seccomp filters, AppArmor/SELinux profiles, capability dropping</td>
</tr>
<tr>
<td><strong>Ease of Use</strong></td>
<td>Very simple, but low-level; needs a prepared root filesystem</td>
<td>Low-level, requires explicit namespace setup; flexible but complex</td>
<td>Higher-level, single command to start an isolated container; integrates with systemd</td>
<td>Higher-level, with CLI, Dockerfiles, image registry, orchestration (Swarm/Kubernetes)</td>
</tr>
<tr>
<td><strong>Networking</strong></td>
<td>Shares host network unless combined with <code>unshare -n</code> or extra setup</td>
<td>Configurable (can isolate network stack or use host)</td>
<td>Defaults to private veth bridge; can integrate with host networking</td>
<td>Advanced networking (bridge, overlay, host, macvlan) with built-in tooling</td>
</tr>
<tr>
<td><strong>Resource Control</strong></td>
<td>None</td>
<td>None (unless you manually apply cgroups)</td>
<td>Yes, via cgroups (CPU, memory, I/O)</td>
<td>Yes, via cgroups (CPU, memory, I/O) with fine-grained limits</td>
</tr>
<tr>
<td><strong>Image Management</strong></td>
<td>None (you prepare the root fs manually)</td>
<td>None</td>
<td>Supports machine images (<code>systemd-nspawn -D /path</code> or <code>--image</code>)</td>
<td>Built-in image distribution via Docker Hub / registries</td>
</tr>
<tr>
<td><strong>Init / PID 1</strong></td>
<td>None (you must run your own init manually)</td>
<td>None (just runs the command you give)</td>
<td>Runs systemd (or chosen init) as PID 1 in the container</td>
<td>Runs whatever you specify (commonly an app, or full init system)</td>
</tr>
<tr>
<td><strong>Typical Use Case</strong></td>
<td>Testing a different root filesystem, rescue/repair</td>
<td>Advanced sandboxing, debugging namespaces</td>
<td>Lightweight containers on a systemd host, testing distros, dev environments</td>
<td>Application containerization, microservices, production deployments</td>
</tr>
</tbody>
</table>
<h2 id="what-do-the-scripts-do">What do the scripts do?</h2>
<h3 id="podman-build">podman build</h3>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>podman<span class="w"> </span>build<span class="w"> </span>-f<span class="w"> </span>contrib/docker/nspawn-build.Dockerfile<span class="w"> </span>-t<span class="w"> </span>belenios-nspawn-image<span class="w"> </span>.
</span></code></pre></div>
Looking at <code>nspawn-build.Dockerfile</code> this, among other things,:</p>
<ul>
<li>builds a Debian image and installs dependencies</li>
<li>sets up the belenios user and ownership</li>
<li>runs the script <code>contrib/debian/setup-build-dir.sh /tmp/build</code> which creates in <code>_docker/build</code>,:<ul>
<li><code>Makefile</code> which is a symbolic link to <code>contrib/debian/build.mk</code></li>
<li><code>Makefile.config</code></li>
</ul>
</li>
</ul>
<h3 id="podman-run">podman run</h3>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>podman<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--name<span class="w"> </span>belcont<span class="w"> </span>--volume<span class="o">=</span><span class="nv">$PWD</span>:/tmp/belenios:Z<span class="w"> </span>--volume<span class="o">=</span><span class="nv">$PWD</span>/_docker/build:/tmp/build:Z<span class="w"> </span>--rm<span class="w"> </span>--userns<span class="o">=</span>keep-id<span class="w"> </span>--privileged<span class="w"> </span>--security-opt<span class="w"> </span><span class="nv">label</span><span class="o">=</span>disable<span class="w"> </span>belenios-nspawn-image
</span></code></pre></div>
This runs in privileged mode with SELinux disabled in the container.</p>
<p>To get a shell inside the container with root privileges do:
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>podman<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>-u<span class="w"> </span><span class="m">0</span><span class="w"> </span>belcont<span class="w"> </span>bash
</span></code></pre></div></p>
<p>When the command <code>make</code> is executed it runs <code>_docker/build/Makefile</code> (a link to <code>contrib/debian/build.mk</code>) which calls:</p>
<ul>
<li>$(SQUASHFS), which calls $(DEB), which calls $(DSC) and $(CHROOT)</li>
<li>$(DSC) runs the script <code>contrib/debian/make-dsc.sh</code> which builds <code>belenios-server_XXX.dsc</code></li>
<li>$(CHROOT) runs the script <code>contrib/debian/make-chroot.sh</code><ul>
<li>it calls <code>config.sh</code></li>
</ul>
</li>
<li>$(DEB) runs the <code>sbuild</code> command to build Debian packages</li>
<li>finally $(SQUASHFS) runs the script <code>contrib/debian/make-squashfs.sh</code></li>
</ul>
<h2 id="to-run-rootfssquashfs-with-systemd-nspawn">To run rootfs.squashfs with systemd-nspawn</h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>sudo<span class="w"> </span>systemd-nspawn<span class="w"> </span>-i<span class="w"> </span>/var/lib/machines/belenios-containers/main/rootfs.squashfs
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1"># Or</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>sudo<span class="w"> </span>systemd-nspawn<span class="w"> </span>-i<span class="w"> </span>/var/lib/machines/belenios-containers/main/rootfs.squashfs<span class="w"> </span>--boot
</span></code></pre></div>
<h2 id="to-run-as-systemd-service">To run as systemd service</h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>belenios-container@main.service
</span></code></pre></div>
<h2 id="inspect-with-machinectl">Inspect with machinectl</h2>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>machinectl<span class="w"> </span>list
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>machinectl<span class="w"> </span>show<span class="w"> </span>rootfs.squashfs
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>machinectl<span class="w"> </span>status<span class="w"> </span>rootfs.squashfs
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># Run interactive shell as root in running container</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>sudo<span class="w"> </span>machinectl<span class="w"> </span>shell<span class="w"> </span>&lt;container<span class="w"> </span>name&gt;
</span></code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>